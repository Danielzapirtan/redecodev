<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Living 002 – Interactive Room</title>
<style>
  body { margin: 0; overflow: hidden; }
  #info {
    position: absolute;
    top: 10px; left: 10px;
    padding: 8px 10px;
    background: #0007; color: #fff;
    font-family: sans-serif;
    border-radius: 4px;
    z-index: 10;
  }
</style>

<!-- Import Map -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<div id="info">Click to enter room (WASD + mouse look)</div>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

// -----------------------------------------------------
// ROOM PARAMETERS
// -----------------------------------------------------
const roomWidth = 5.0;
const roomDepth = 4.0;
const roomHeight = 2.2;

// -----------------------------------------------------
// SCENE + CAMERA
// -----------------------------------------------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xbfd1df);

const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 50);
camera.position.set(0, 1.6, 1.5); // human-height camera inside room

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// -----------------------------------------------------
// CONTROLS (Pointer Lock for indoor walking)
// -----------------------------------------------------
const controls = new PointerLockControls(camera, document.body);

document.body.addEventListener('click', () => {
  controls.lock();
});

// Movement state
const move = { forward: false, backward: false, left: false, right: false };
const velocity = new THREE.Vector3();

document.addEventListener('keydown', (e) => {
  if (e.code === 'KeyW') move.forward = true;
  if (e.code === 'KeyS') move.backward = true;
  if (e.code === 'KeyA') move.left = true;
  if (e.code === 'KeyD') move.right = true;
});

document.addEventListener('keyup', (e) => {
  if (e.code === 'KeyW') move.forward = false;
  if (e.code === 'KeyS') move.backward = false;
  if (e.code === 'KeyA') move.left = false;
  if (e.code === 'KeyD') move.right = false;
});

// -----------------------------------------------------
// LIGHTS
// -----------------------------------------------------
scene.add(new THREE.HemisphereLight(0xffffff, 0x555555, 1.1));

const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(5, 8, 5);
scene.add(dir);

// -----------------------------------------------------
// BUILD ROOM (NO CEILING)
// -----------------------------------------------------
const wallMaterial = new THREE.MeshStandardMaterial({ color: 0xf0f0f0 });
const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xdddddd });

const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(roomWidth, roomDepth),
  floorMaterial
);
floor.rotation.x = -Math.PI / 2;
floor.position.set(0, 0, 0);
scene.add(floor);

// Walls (front, back, left, right)
function wall(w, h, pos, rotY = 0) {
  const mesh = new THREE.Mesh(
    new THREE.PlaneGeometry(w, h),
    wallMaterial
  );
  mesh.position.set(pos.x, pos.y, pos.z);
  mesh.rotation.y = rotY;
  scene.add(mesh);
}

wall(roomWidth, roomHeight, { x: 0, y: roomHeight/2, z: -roomDepth/2 });              // back
wall(roomWidth, roomHeight, { x: 0, y: roomHeight/2, z: roomDepth/2 }, Math.PI);      // front
wall(roomDepth, roomHeight, { x: -roomWidth/2, y: roomHeight/2, z: 0 }, Math.PI/2);   // left
wall(roomDepth, roomHeight, { x: roomWidth/2,  y: roomHeight/2, z: 0 }, -Math.PI/2);  // right

// -----------------------------------------------------
// DOORS (simple rectangular cutouts)
// (west-southwest, south-southwest → interpret as left wall & front wall)
// -----------------------------------------------------
function door(width = 0.9, height = 2.0) {
  return new THREE.Mesh(
    new THREE.BoxGeometry(width, height, 0.05),
    new THREE.MeshStandardMaterial({ color: 0x6b4f2c })
  );
}

const door1 = door();
door1.position.set(-roomWidth/2 + 0.05, 1.0, -1.0);
scene.add(door1);

const door2 = door();
door2.position.set(0, 1.0, roomDepth/2 - 0.05);
scene.add(door2);

// -----------------------------------------------------
// WINDOW (east wall, centered, 1m wide, 3 panels)
// -----------------------------------------------------
const windowGroup = new THREE.Group();
const totalWidth = 1.0;
const panels = 3;
const panelWidth = totalWidth / panels;

for (let i = 0; i < panels; i++) {
  const frame = new THREE.Mesh(
    new THREE.PlaneGeometry(panelWidth * 0.95, 1.0),
    new THREE.MeshStandardMaterial({ color: 0x99bbff, transparent: true, opacity: 0.5 })
  );
  frame.position.x = (i - (panels/2 - 0.5)) * panelWidth;
  windowGroup.add(frame);
}
windowGroup.position.set(roomWidth/2 - 0.02, 1.2, 0);
windowGroup.rotation.y = -Math.PI/2;
scene.add(windowGroup);

// -----------------------------------------------------
// LOAD FURNITURE MODELS (REAL EXISTING ONES)
// -----------------------------------------------------
const loader = new GLTFLoader();

// 1. L-shaped sofa → using "Sofa" model
loader.load(
  "https://threejs.org/examples/models/gltf/Sofa/glTF/Sofa.gltf",
  (gltf) => {
    const sofa = gltf.scene;
    sofa.scale.set(1.0, 1.0, 1.0);
    sofa.position.set(-1.5, 0, 1.2);
    sofa.rotation.y = Math.PI / 4;
    scene.add(sofa);
  }
);

// 2. TV → using “Littlest Tokyo” components
loader.load(
  "https://threejs.org/examples/models/gltf/LittlestTokyo.glb",
  (gltf) => {
    const tv = gltf.scene;
    tv.scale.set(0.01, 0.01, 0.01);
    tv.position.set(1.8, 0, -1.6);
    tv.rotation.y = -Math.PI/2;
    scene.add(tv);
  }
);

// 3. Armchairs (2 copies)
loader.load(
  "https://threejs.org/examples/models/gltf/Chair/Chair.glb",
  (gltf) => {
    const base = gltf.scene;

    const c1 = base.clone();
    c1.scale.set(1.2, 1.2, 1.2);
    c1.position.set(1.0, 0, 1.3);
    scene.add(c1);

    const c2 = base.clone();
    c2.scale.set(1.2, 1.2, 1.2);
    c2.position.set(0.3, 0, 1.6);
    c2.rotation.y = Math.PI/6;
    scene.add(c2);
  }
);

// 4. Bookcase → reuse “Stool” model stretched
loader.load(
  "https://threejs.org/examples/models/gltf/Stool/glTF/Stool.gltf",
  (gltf) => {
    const shelf = gltf.scene;
    shelf.scale.set(3.0, 2.2, 0.4);
    shelf.position.set(-1.5, 0, -1.8);
    scene.add(shelf);
  }
);

// -----------------------------------------------------
// ANIMATION LOOP (with WASD movement)
// -----------------------------------------------------
function animate() {
  requestAnimationFrame(animate);

  if (controls.isLocked) {
    const speed = 0.025;

    if (move.forward) velocity.z = -speed;
    else if (move.backward) velocity.z = speed;
    else velocity.z = 0;

    if (move.left) velocity.x = -speed;
    else if (move.right) velocity.x = speed;
    else velocity.x = 0;

    controls.moveRight(velocity.x);
    controls.moveForward(velocity.z);
  }

  renderer.render(scene, camera);
}
animate();

// -----------------------------------------------------
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
